(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{511:function(e,t,a){"use strict";a.r(t);var r=a(4),s=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",[e._v("如何在filebeat里创建一个自定义module")])]),e._v(" "),a("h2",{attrs:{id:"使用make命令创建一个module"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用make命令创建一个module"}},[e._v("#")]),e._v(" 使用make命令创建一个module")]),e._v(" "),a("p",[e._v("下载filebeat代码，然后编译。"),a("br"),e._v("\n详细方法可以参考，"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/devguide/6.8/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("beats教程"),a("OutboundLink")],1)]),e._v(" "),a("h3",{attrs:{id:"_1-创建一个新的module"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建一个新的module"}},[e._v("#")]),e._v(" 1. 创建一个新的module")]),e._v(" "),a("p",[e._v("module相当于对应一个应用。"),a("br"),e._v("\n切换到beats下的filebeat目录，执行以下命令"),a("br"),e._v(" "),a("code",[e._v("make create-module MODULE={module}")]),e._v("\nmodule.yml存放的是kibana dashboard配置。")]),e._v(" "),a("h3",{attrs:{id:"_2-创建一个fileset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建一个fileset"}},[e._v("#")]),e._v(" 2. 创建一个fileset")]),e._v(" "),a("p",[e._v("fileset相当于一个log文件对应的配置"),a("br"),e._v("\n使用命令：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("make create-fileset MODULE={module} FILESET={fileset}\n")])])]),a("p",[e._v("其中")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("manifest.yml")]),e._v("是模块的控制文件，可以通过双层括号的语法来使用内置或者定义的变量。"),a("br"),e._v("\n它的"),a("code",[e._v("var")]),e._v("部分是定义变量及其默认值，并且其可以在runtime被filebeat参数覆盖。"),a("br"),e._v("\n其中还保存着"),a("code",[e._v("ingest pipeline")]),e._v("和"),a("code",[e._v("input")])])]),e._v(" "),a("li",[a("p",[a("code",[e._v("ingest pipeline")]),e._v(" ingest pipeline配置文件夹，可以配置多个文件。")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("config/*.yml")]),e._v("用于生成filebeat输入配置")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("ingest/*.json")]),e._v("包含的是elasticsearch的ingest node pipeline配置。可以配置多个pipeline，但是只会有一个在运行时被加载。"),a("br"),e._v("\n你可以向processors里面添加processor来做具体的解析。"),a("br"),e._v("\n详情可以"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/ingest.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("ingest node"),a("OutboundLink")],1),e._v("和"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/ingest-processors.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("processors"),a("OutboundLink")],1),e._v("参考文档。")])])]),e._v(" "),a("h2",{attrs:{id:"运行module"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行module"}},[e._v("#")]),e._v(" 运行module")]),e._v(" "),a("h3",{attrs:{id:"参数设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数设置"}},[e._v("#")]),e._v(" 参数设置")]),e._v(" "),a("p",[e._v("特定module的参数可以在配置文件中设置，也可以使用命令行设置，如")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('- module: nginx\n  access:\n    var.paths: ["/var/log/nginx/access.log*"]\n')])])]),a("p",[e._v("对应")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('filebeat -e -M "nginx.access.var.paths=[/var/log/nginx/access.log*]"\n')])])]),a("p",[e._v("格式为"),a("code",[e._v("${moduleName}.${fileSetName}.${configPath}")])]),e._v(" "),a("h4",{attrs:{id:"输入参数设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#输入参数设置"}},[e._v("#")]),e._v(" 输入参数设置")]),e._v(" "),a("p",[e._v("以type为log的例子挑选几个配置来说明："),a("br"),e._v("\n针对输入数据的配置都在input配置下面，针对输出到数据存储系统的都在output下面。")]),e._v(" "),a("p",[e._v("在"),a("code",[e._v("config/*.json")]),e._v("里设置相应的配置"),a("br"),e._v("\n比如针对jvm stacktrace，可以使用multiline设置，将多行log作为一个事件处理。具体设置"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/6.8/multiline-examples.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("参考"),a("OutboundLink")],1),e._v("。"),a("br"),e._v(" "),a("code",[e._v("processors")]),e._v("代表一系列用于输入数据的处理器"),a("br"),e._v("\n具体其他设置可以参考"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/6.8/configuration-filebeat-options.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("config inputs"),a("OutboundLink")],1),e._v("。"),a("br"),e._v("\n在配置中可以使用go标准的模板语法，详细可以参考"),a("a",{attrs:{href:"https://golang.org/pkg/text/template/",target:"_blank",rel:"noopener noreferrer"}},[e._v("go template"),a("OutboundLink")],1),e._v("."),a("br"),e._v("\n我们在实际处理过程中可以使用grok processor来提取log字段，grok使用正则来分隔字段，并且具有很多内置匹配模式，可以直接使用，匹配模式可以参考"),a("a",{attrs:{href:"https://github.com/elastic/logstash/blob/v1.4.0/patterns/grok-patterns",target:"_blank",rel:"noopener noreferrer"}},[e._v("logstash grok-patterns"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"debug-filebeat"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#debug-filebeat"}},[e._v("#")]),e._v(" debug filebeat")]),e._v(" "),a("p",[e._v("filebeat可以设置参数来配置日志和位置记录文件的存放位置。"),a("br"),e._v("\nfilebeat enable modules命令:"),a("br"),e._v(" "),a("code",[e._v("./filebeat modules enable apache")]),e._v("\nfilebeat upload ingest pipeline命令：\n"),a("code",[e._v("./filebeat setup --pipeline --modules apache")])]),e._v(" "),a("p",[e._v("filebeat启动解析文件的日志为"),a("code",[e._v("Harvester started for file:")]),e._v("，可以通过这个标志判断是否找到了需要解析的日志。"),a("br"),e._v("\n指定文件路径的时候，文件匹配符不支持类似"),a("code",[e._v("[0-9]+")]),e._v("，建议使用"),a("code",[e._v("[0-9]*")]),e._v("。"),a("br"),e._v("\n针对带有小数的时间戳，类似"),a("code",[e._v("2020-06-22 15:45:42.798291")]),e._v("是可以被grok的"),a("code",[e._v("TIMESTAMP_ISO8601")]),e._v("格式匹配上。但是使用"),a("code",[e._v("date")]),e._v(" processor的解析时格式设置为"),a("code",[e._v("ISO8601")]),e._v("无法解析，需要自己指定格式为"),a("code",[e._v("yyyy-MM-dd HH:mm:ss.SSSSSS")]),e._v(",秒的小数部分用"),a("code",[e._v("S")]),e._v("表示。")])])}),[],!1,null,null,null);t.default=s.exports}}]);